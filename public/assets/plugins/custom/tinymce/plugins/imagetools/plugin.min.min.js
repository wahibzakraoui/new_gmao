!function(t){"use strict";var e,n,r,o=function(t){var e=t;return{get:function(){return e},set:function(t){e=t}}},i=tinymce.util.Tools.resolve("tinymce.PluginManager"),u=tinymce.util.Tools.resolve("tinymce.util.Tools"),a=function(t){return function(){return t}},c=a(!1),s=a(!0),f=function(){return l},l=(e=function(t){return t.isNone()},{fold:function(t,e){return t()},is:c,isSome:c,isNone:s,getOr:r=function(t){return t},getOrThunk:n=function(t){return t()},getOrDie:function(t){throw new Error(t||"error: getOrDie called on none.")},getOrNull:a(null),getOrUndefined:a(void 0),or:r,orThunk:n,map:f,each:function(){},bind:f,exists:c,forall:s,filter:f,equals:e,equals_:e,toArray:function(){return[]},toString:a("none()")}),d=function(t){var e=a(t),n=function(){return o},r=function(e){return e(t)},o={fold:function(e,n){return n(t)},is:function(e){return t===e},isSome:s,isNone:c,getOr:e,getOrThunk:e,getOrDie:e,getOrNull:e,getOrUndefined:e,or:n,orThunk:n,map:function(e){return d(e(t))},each:function(e){e(t)},bind:r,exists:r,forall:r,filter:function(e){return e(t)?o:l},toArray:function(){return[t]},toString:function(){return"some("+t+")"},equals:function(e){return e.is(t)},equals_:function(e,n){return e.fold(c,(function(e){return n(t,e)}))}};return o},h={some:d,none:f,from:function(t){return null==t?l:d(t)}};function m(e,n){return v(t.document.createElement("canvas"),e,n)}function g(t){var e=m(t.width,t.height);return p(e).drawImage(t,0,0),e}function p(t){return t.getContext("2d")}function v(t,e,n){return t.width=e,t.height=n,t}var y,w,b,I=window.Promise?window.Promise:(w=(y=function(t){if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");if("function"!=typeof t)throw new TypeError("not a function");this._state=null,this._value=null,this._deferreds=[],j(t,_(T,this),_(U,this))}).immediateFn||"function"==typeof window.setImmediate&&window.setImmediate||function(e){t.setTimeout(e,1)},b=Array.isArray||function(t){return"[object Array]"===Object.prototype.toString.call(t)},y.prototype.catch=function(t){return this.then(null,t)},y.prototype.then=function(t,e){var n=this;return new y((function(r,o){R.call(n,new E(t,e,r,o))}))},y.all=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=Array.prototype.slice.call(1===t.length&&b(t[0])?t[0]:t);return new y((function(t,e){if(0===n.length)return t([]);var r=n.length;function o(i,u){try{if(u&&("object"==typeof u||"function"==typeof u)){var a=u.then;if("function"==typeof a)return void a.call(u,(function(t){o(i,t)}),e)}n[i]=u,0==--r&&t(n)}catch(t){e(t)}}for(var i=0;i<n.length;i++)o(i,n[i])}))},y.resolve=function(t){return t&&"object"==typeof t&&t.constructor===y?t:new y((function(e){e(t)}))},y.reject=function(t){return new y((function(e,n){n(t)}))},y.race=function(t){return new y((function(e,n){for(var r=0,o=t;r<o.length;r++)o[r].then(e,n)}))},y);function _(t,e){return function(){return t.apply(e,arguments)}}function R(t){var e=this;null!==this._state?w((function(){var n=e._state?t.onFulfilled:t.onRejected;if(null!==n){var r;try{r=n(e._value)}catch(e){return void t.reject(e)}t.resolve(r)}else(e._state?t.resolve:t.reject)(e._value)})):this._deferreds.push(t)}function T(t){try{if(t===this)throw new TypeError("A promise cannot be resolved with itself.");if(t&&("object"==typeof t||"function"==typeof t)){var e=t.then;if("function"==typeof e)return void j(_(e,t),_(T,this),_(U,this))}this._state=!0,this._value=t,A.call(this)}catch(t){U.call(this,t)}}function U(t){this._state=!1,this._value=t,A.call(this)}function A(){for(var t=0,e=this._deferreds;t<e.length;t++){var n=e[t];R.call(this,n)}this._deferreds=[]}function E(t,e,n,r){this.onFulfilled="function"==typeof t?t:null,this.onRejected="function"==typeof e?e:null,this.resolve=n,this.reject=r}function j(t,e,n){var r=!1;try{t((function(t){r||(r=!0,e(t))}),(function(t){r||(r=!0,n(t))}))}catch(t){if(r)return;r=!0,n(t)}}function x(e){return new I((function(n,r){var o=t.URL.createObjectURL(e),i=new t.Image,u=function(){i.removeEventListener("load",a),i.removeEventListener("error",c)};function a(){u(),n(i)}function c(){u(),r("Unable to load data of type "+e.type+": "+o)}i.addEventListener("load",a),i.addEventListener("error",c),i.src=o,i.complete&&a()}))}function k(e){return new I((function(n,r){(function(e){var n=e.split(","),r=/data:([^;]+)/.exec(n[0]);if(!r)return h.none();for(var o=r[1],i=n[1],u=t.atob(i),a=u.length,c=Math.ceil(a/1024),s=new Array(c),f=0;f<c;++f){for(var l=1024*f,d=Math.min(1024+l,a),m=new Array(d-l),g=l,p=0;g<d;++p,++g)m[p]=u[g].charCodeAt(0);s[f]=new Uint8Array(m)}return h.some(new t.Blob(s,{type:o}))})(e).fold((function(){r("uri is not base64: "+e)}),n)}))}function C(e,n,r){return n=n||"image/png",t.HTMLCanvasElement.prototype.toBlob?new I((function(t,o){e.toBlob((function(e){e?t(e):o()}),n,r)})):k(e.toDataURL(n,r))}function L(t,e,n){var r=e.type;function o(e,n){return t.then((function(t){return function(t,e,n){return e=e||"image/png",t.toDataURL(e,n)}(t,e,n)}))}return{getType:a(r),toBlob:function(){return I.resolve(e)},toDataURL:a(n),toBase64:function(){return n.split(",")[1]},toAdjustedBlob:function(e,n){return t.then((function(t){return C(t,e,n)}))},toAdjustedDataURL:o,toAdjustedBase64:function(t,e){return o(t,e).then((function(t){return t.split(",")[1]}))},toCanvas:function(){return t.then(g)}}}function O(e){return function(e){return new I((function(n){var r=new t.FileReader;r.onloadend=function(){n(r.result)},r.readAsDataURL(e)}))}(e).then((function(n){return L(function(e){return x(e).then((function(e){!function(e){t.URL.revokeObjectURL(e.src)}(e);var n=m(function(t){return t.naturalWidth||t.width}(e),function(t){return t.naturalHeight||t.height}(e));return p(n).drawImage(e,0,0),n}))}(e),e,n)}))}function S(t,e){return C(t,e).then((function(e){return L(I.resolve(t),e,t.toDataURL())}))}var P=("function",function(t){return"function"==typeof t}),B=function(t,e){return function(t,e,n){for(var r=0,o=t.length;r<o;r++){var i=t[r];if(e(i,r))return h.some(i);if(n(i,r))break}return h.none()}(t,e,c)},M=function(t){return O(t)},N=function(t){if(null==t)throw new Error("Node cannot be null or undefined");return{dom:a(t)}},F=N,D=(void 0!==t.window?t.window:Function("return this;")(),P(t.Element.prototype.attachShadow)&&P(t.Node.prototype.getRootNode),function(t,e){return n=function(t){return function(t,e){var n=t.dom();if(1!==n.nodeType)return!1;var r=n;if(void 0!==r.matches)return r.matches(e);if(void 0!==r.msMatchesSelector)return r.msMatchesSelector(e);if(void 0!==r.webkitMatchesSelector)return r.webkitMatchesSelector(e);if(void 0!==r.mozMatchesSelector)return r.mozMatchesSelector(e);throw new Error("Browser lacks native selectors")}(t,e)},B(t.dom().childNodes,(function(t){return n(F(t))})).map(F);var n}),q=tinymce.util.Tools.resolve("tinymce.util.Delay"),H=tinymce.util.Tools.resolve("tinymce.util.Promise"),z=tinymce.util.Tools.resolve("tinymce.util.URI"),$=function(t){return t.getParam("imagetools_proxy")};function G(t){var e,n;function r(t){return/^[0-9\.]+px$/.test(t)}return e=t.style.width,n=t.style.height,e||n?r(e)&&r(n)?{w:parseInt(e,10),h:parseInt(n,10)}:null:(e=t.width,n=t.height,e&&n?{w:parseInt(e,10),h:parseInt(n,10)}:null)}function J(t){return{w:t.naturalWidth,h:t.naturalHeight}}var K=function(t){return null!=t},V=function(e,n,r){return new H((function(o){var i=new t.XMLHttpRequest;i.onreadystatechange=function(){4===i.readyState&&o({status:i.status,blob:this.response})},i.open("GET",e,!0),i.withCredentials=r,u.each(n,(function(t,e){i.setRequestHeader(e,t)})),i.responseType="blob",i.send()}))},W=[{code:404,message:"Could not find Image Proxy"},{code:403,message:"Rejected request"},{code:0,message:"Incorrect Image Proxy URL"}],X=[{type:"key_missing",message:"The request did not include an api key."},{type:"key_not_found",message:"The provided api key could not be found."},{type:"domain_not_trusted",message:"The api key is not valid for the request origins."}],Q=function(t){var e,n=(e=t,"ImageProxy HTTP error: "+B(W,(function(t){return e===t.code})).fold(a("Unknown ImageProxy error"),(function(t){return t.message})));return H.reject(n)},Y=function(e,n){return r=n,new H((function(e){var n=new t.FileReader;n.onload=function(t){var n=t.target;e(n.result)},n.readAsText(r)})).then((function(t){var e=function(t){var e,n,r=function(t){var e;try{e=JSON.parse(t)}catch(t){}return e}(t),o=(e=["error","type"].reduce((function(t,e){return K(t)?t[e]:void 0}),r),K(e)?e:null);return"ImageProxy Service error: "+(o?(n=o,B(X,(function(t){return t.type===n})).fold(a("Unknown service error"),(function(t){return t.message}))):"Invalid JSON in service error message")}(t);return H.reject(e)}));var r},Z=function(t,e,n){return e?function(t,e){var n,r,o,i={"Content-Type":"application/json;charset=UTF-8","tiny-api-key":e};return V((r=e,o=-1===(n=t).indexOf("?")?"?":"&",/[?&]apiKey=/.test(n)||!r?n:n+o+"apiKey="+encodeURIComponent(r)),i,!1).then((function(t){return t.status<200||300<=t.status?(e=t.status,n=t.blob,400===(r=e)||403===r||500===r?Y(0,n):Q(e)):H.resolve(t.blob);var e,n,r}))}(t,e):function(t,e){return V(t,{},e).then((function(t){return t.status<200||300<=t.status?Q(t.status):H.resolve(t.blob)}))}(t,n)},tt=0,et=function(t){return D(F(t),"img")},nt=function(t,e){return t.dom.is(e,"figure")},rt=function(t,e){var n=function(e){return n=e,t.dom.is(n,"img:not([data-mce-object],[data-mce-placeholder])")&&(ut(t,e)||at(t,e)||$(t));var n};return nt(t,e)?et(e).map((function(t){return n(t.dom())?h.some(t.dom()):h.none()})):n(e)?h.some(e):h.none()},ot=function(t,e){t.notificationManager.open({text:e,type:"error"})},it=function(t){var e=t.selection.getNode();return nt(t,e)?et(e):h.some(F(e))},ut=function(t,e){var n=e.src;return 0===n.indexOf("data:")||0===n.indexOf("blob:")||new z(n).host===t.documentBaseURI.host},at=function(t,e){return-1!==u.inArray(t.getParam("imagetools_cors_hosts",[],"string[]"),new z(e.src).host)},ct=function(e,n){var r,o,i,a,c=n.src;return at(e,n)?Z(n.src,null,(o=e,i=n,-1!==u.inArray(o.getParam("imagetools_credentials_hosts",[],"string[]"),new z(i.src).host))):ut(e,n)?function(e){var n=e.src;return(0===n.indexOf("data:")?k:function(e){return new I((function(n,r){var o=new t.XMLHttpRequest;o.open("GET",e,!0),o.responseType="blob",o.onload=function(){200===this.status&&n(this.response)},o.onerror=function(){var t;r(0===this.status?((t=new Error("No access to download image")).code=18,t.name="SecurityError",t):new Error("Error "+this.status+" downloading image"))},o.send()}))})(n)}(n):(c=$(e),c+=(-1===c.indexOf("?")?"?":"&")+"url="+encodeURIComponent(n.src),r=(a=e).getParam("api_key",a.getParam("imagetools_api_key","","string"),"string"),Z(c,r,!1))},st=function(t,e){var n=t.editorUpload.blobCache.getByUri(e.src);return n?H.resolve(n.blob()):function(t,e){return n=t,h.from(n.getParam("imagetools_fetch_image",null,"function")).fold((function(){return ct(t,e)}),(function(t){return t(e)}));var n}(t,e)},ft=function(t){q.clearTimeout(t.get())},lt=function(t,e,n,r,o,i){return e.toBlob().then((function(u){var a,c,s,f,l,d=t.editorUpload.blobCache;return a=o.src,t.getParam("images_reuse_filename",!1,"boolean")&&(c=(s=d.getByUri(a))?(a=s.uri(),s.name()):(f=t,(l=a.match(/\/([^\/\?]+)?\.(?:jpeg|jpg|png|gif)(?:\?|$)/i))?f.dom.encode(l[1]):null)),s=d.create({id:"imagetools"+tt++,blob:u,base64:e.toBase64(),uri:a,name:c}),d.add(s),t.undoManager.transact((function(){t.$(o).on("load",(function e(){var i,u,a;t.$(o).off("load",e),t.nodeChanged(),n?t.editorUpload.uploadImagesAuto():(ft(r),i=t,u=r,a=q.setEditorTimeout(i,(function(){i.editorUpload.uploadImagesAuto()}),i.getParam("images_upload_timeout",3e4,"number")),u.set(a))})),i&&t.$(o).attr({width:i.w,height:i.h}),t.$(o).attr({src:s.blobUri()}).removeAttr("data-mce-src")})),s}))},dt=function(t,e,n,r){return function(){return it(t).fold((function(){ot(t,"Could not find selected image")}),(function(o){return t._scanForImages().then((function(){return st(t,o.dom())})).then(M).then(n).then((function(n){return lt(t,n,!1,e,o.dom(),r)}),(function(e){ot(t,e)}))}))}},ht=function(t,e,n){return function(){var r=it(t).fold((function(){return null}),(function(t){var e=G(t.dom());return e?{w:e.h,h:e.w}:null}));return dt(t,e,(function(t){return function(t,e){return t.toCanvas().then((function(n){return function(t,e,n){var r=m(t.width,t.height),o=p(r),i=0,u=0;return 90!==(n=n<0?360+n:n)&&270!==n||v(r,r.height,r.width),90!==n&&180!==n||(i=r.width),270!==n&&180!==n||(u=r.height),o.translate(i,u),o.rotate(n*Math.PI/180),o.drawImage(t,0,0),S(r,e)}(n,t.getType(),e)}))}(t,n)}),r)()}},mt=function(t,e,n){return function(){return dt(t,e,(function(t){return function(t,e){return t.toCanvas().then((function(n){return function(t,e,n){var r=m(t.width,t.height),o=p(r);return"v"===n?(o.scale(1,-1),o.drawImage(t,0,-r.height)):(o.scale(-1,1),o.drawImage(t,-r.width,0)),S(r,e)}(n,t.getType(),e)}))}(t,n)}))()}},gt=function(e,n){return function(){var r=it(e),o=r.map((function(t){return J(t.dom())}));it(e).each((function(i){rt(e,i.dom()).each((function(u){st(e,i.dom()).then((function(i){var u,a={blob:u=i,url:t.URL.createObjectURL(u)};e.windowManager.open({title:"Edit Image",size:"large",body:{type:"panel",items:[{type:"imagetools",name:"imagetools",label:"Edit Image",currentState:a}]},buttons:[{type:"cancel",name:"cancel",text:"Cancel"},{type:"submit",name:"save",text:"Save",primary:!0,disabled:!0}],onSubmit:function(i){var u=i.getData().imagetools.blob;r.each((function(r){o.each((function(o){!function(e,n,r,o,i){x(i).then((function(e){var n=J(e);return o.w===n.w&&o.h===n.h||G(r)&&function(t,e){var n,r;e&&(n=t.style.width,r=t.style.height,(n||r)&&(t.style.width=e.w+"px",t.style.height=e.h+"px",t.removeAttribute("data-mce-style")),n=t.width,r=t.height,(n||r)&&(t.setAttribute("width",e.w),t.setAttribute("height",e.h)))}(r,n),t.URL.revokeObjectURL(e.src),i})).then(M).then((function(t){return lt(e,t,!0,n,r)}),(function(){}))}(e,n,r.dom(),o,u)}))})),i.close()},onCancel:function(){},onAction:function(t,e){switch(e.name){case"save-state":e.value?t.enable("save"):t.disable("save");break;case"disable":t.disable("save"),t.disable("cancel");break;case"enable":t.enable("cancel")}}})}))}))}))}};i.add("imagetools",(function(t){var e,n,r,i,a,c,s,f,l=o(0),d=o(null);e=t,n=l,u.each({mceImageRotateLeft:ht(e,n,-90),mceImageRotateRight:ht(e,n,90),mceImageFlipVertical:mt(e,n,"v"),mceImageFlipHorizontal:mt(e,n,"h"),mceEditImage:gt(e,n)},(function(t,n){e.addCommand(n,t)})),i=function(t){return function(){return r.execCommand(t)}},(r=t).ui.registry.addButton("rotateleft",{tooltip:"Rotate counterclockwise",icon:"rotate-left",onAction:i("mceImageRotateLeft")}),r.ui.registry.addButton("rotateright",{tooltip:"Rotate clockwise",icon:"rotate-right",onAction:i("mceImageRotateRight")}),r.ui.registry.addButton("flipv",{tooltip:"Flip vertically",icon:"flip-vertically",onAction:i("mceImageFlipVertical")}),r.ui.registry.addButton("fliph",{tooltip:"Flip horizontally",icon:"flip-horizontally",onAction:i("mceImageFlipHorizontal")}),r.ui.registry.addButton("editimage",{tooltip:"Edit image",icon:"edit-image",onAction:i("mceEditImage"),onSetup:function(t){var e=function(){it(r).each((function(e){var n=rt(r,e.dom()).isNone();t.setDisabled(n)}))};return r.on("NodeChange",e),function(){r.off("NodeChange",e)}}}),r.ui.registry.addButton("imageoptions",{tooltip:"Image options",icon:"image-options",onAction:i("mceImage")}),r.ui.registry.addContextMenu("imagetools",{update:function(t){return rt(r,t).fold((function(){return[]}),(function(t){return[{text:"Edit image",icon:"edit-image",onAction:i("mceEditImage")}]}))}}),(a=t).ui.registry.addContextToolbar("imagetools",{items:a.getParam("imagetools_toolbar","rotateleft rotateright flipv fliph editimage imageoptions"),predicate:function(t){return rt(a,t).isSome()},position:"node",scope:"node"}),s=l,f=d,(c=t).on("NodeChange",(function(t){var e=f.get();e&&e.src!==t.element.src&&(ft(s),c.editorUpload.uploadImagesAuto(),f.set(null)),rt(c,t.element).each(f.set)}))}))}(window);